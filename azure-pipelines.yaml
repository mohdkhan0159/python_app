trigger:
  branches:
    include:
      - main

variables:
  - group: terraform-keys              # secrets from Key Vault
  - group: learning_platform_vg        # all non-secret variables

stages:

# =====================================================
#    STAGE 1 — Build & Push Docker Image
# =====================================================
- stage: BuildAndPush
  displayName: Build and Push to ACR
  jobs:
    - job: Build
      pool:
        vmImage: ubuntu-latest

      steps:
        - task: DockerInstaller@0
          displayName: Install Docker

        - task: AzureCLI@2
          displayName: Login to ACR
          inputs:
            azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az acr login --name $(ACR_NAME)

        - script: |
            docker build -t $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG) .
            docker push $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)
          displayName: Build and Push Image


# =====================================================
#    STAGE 2 — Deploy to AKS Using Helm
# =====================================================
- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: BuildAndPush
  jobs:
    - deployment: AKS_Deployment
      environment: "aks/$(AKS_ENVIRONMENT)"
      pool:
        vmImage: ubuntu-latest

      strategy:
        runOnce:
          deploy:
            steps:

              # --------------------------
              # 1. Get AKS Credentials
              # --------------------------
              - task: AzureCLI@2
                displayName: Get AKS credentials
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az aks get-credentials \
                      --resource-group $(AKS_RESOURCE_GROUP) \
                      --name $(AKS_CLUSTER_NAME) \
                      --overwrite-existing

                    # Ensure namespace exists
                    kubectl get namespace $(K8S_NAMESPACE) || \
                      kubectl create namespace $(K8S_NAMESPACE)


              # --------------------------
              # 2. Generate Helm secrets file
              # --------------------------
              - task: Bash@3
                displayName: Generate values.secrets.yaml
                inputs:
                  targetType: inline
                  script: |
                    cat > values.secrets.yaml <<EOF
                    secrets:
                      SESSION_SECRET: "$(SESSION_SECRET)"
                      DATABASE_URL: "$(AZURE_SQL_CONNECTION_STRING)"
                      AZURE_STORAGE_CONNECTION_STRING: "$(AZURE_STORAGE_CONNECTION_STRING)"
                      AZURE_STORAGE_ACCOUNT_NAME: "$(AZURE_STORAGE_ACCOUNT_NAME)"
                      AZURE_STORAGE_ACCOUNT_KEY: "$(AZURE_STORAGE_ACCOUNT_KEY)"
                    EOF


              # --------------------------
              # 3. Install Helm
              # --------------------------
              - task: HelmInstaller@1
                displayName: Install Helm
                inputs:
                  helmVersionToInstall: latest


              # --------------------------
              # 4. Deploy with Helm
              # --------------------------
              - task: HelmDeploy@0
                displayName: Deploy Helm Chart
                inputs:
                  connectionType: Kubernetes Service Connection
                  kubernetesServiceConnection: "$(K8S_SERVICE_CONNECTION)"
                  namespace: "$(K8S_NAMESPACE)"        # <--- NOW using your namespace variable
                  command: upgrade
                  chartType: FilePath
                  chartPath: "$(HELM_CHART_PATH)"
                  releaseName: "$(HELM_RELEASE_NAME)"
                  valueFile: "values.secrets.yaml"
                  install: true
                  waitForExecution: true
                  set: |
                    image.repository=$(ACR_LOGIN_SERVER)/$(IMAGE_NAME)
                    image.tag=$(IMAGE_TAG)
